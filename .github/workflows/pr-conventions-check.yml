name: PR Conventions Check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

concurrency:
  group: pr-conventions-check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read            # required to read files / list PR files
  pull-requests: read
  issues: write             # required to create/update comments

jobs:
  enforce-conventions:
    name: Enforce PR conventions & tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Gather PR body and changed files
        id: get_pr_data
        uses: actions/github-script@v6
        with:
          script: |
            /**
             * Fetch PR body and list changed files (paginated).
             * Exposes outputs:
             *   pr_body - limited to first 8000 chars for logs/outputs
             *   files_json - JSON array [{ filename, status }]
             */
            try {
              const pr = context.payload.pull_request;
              if (!pr) {
                core.info('No pull_request in context (maybe this run was triggered differently).');
                core.setOutput('pr_body', '');
                core.setOutput('files_json', '[]');
                return;
              }

              const prNumber = pr.number;
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const per_page = 100;
              let page = 1;
              const files = [];

              while (true) {
                const res = await github?.pulls?.listFiles?.({
                  owner,
                  repo,
                  pull_number: prNumber,
                  per_page,
                  page
                });

                if (!res || !res.data) break;
                for (const f of res.data) {
                  files.push({ filename: f.filename, status: f.status || null });
                }

                if (res.data.length < per_page) break;
                page += 1;

                // Defensive: don't loop forever on unexpected conditions
                if (page > 50) {
                  core.info('Pagination guard tripped (page > 50). Stopping further fetches.');
                  break;
                }
              }

              // set outputs (stringified)
              core.setOutput('pr_body', (pr.body || '').substring(0, 8000));
              core.setOutput('files_json', JSON.stringify(files));
              core.info(`Found ${files.length} changed files in PR #${prNumber}`);
            } catch (err) {
              core.error('Failed to collect PR data: ' + String(err));
              core.setOutput('pr_body', '');
              core.setOutput('files_json', '[]');
            }

      - name: Print PR body and changed files (non-failing)
        id: debug_print
        uses: actions/github-script@v6
        with:
          script: |
            // Print PR body and file list for diagnostics (non-failing)
            const prBody = '${{ steps.get_pr_data.outputs.pr_body }}' || '';
            const files = JSON.parse('${{ steps.get_pr_data.outputs.files_json }}' || '[]');

            core.info('--- PR BODY START ---');
            core.info(prBody || '(empty)');
            core.info('--- PR BODY END ---');

            core.info(`Changed files (${files.length}):`);
            for (const f of files.slice(0, 500)) {
              core.info(` - ${f.filename}`);
            }
            if (files.length > 500) core.info(`... (${files.length - 500} more files omitted from log)`);

      - name: Check PR body and changed files for conventions and tests
        id: check_conventions
        uses: actions/github-script@v6
        env:
          PR_BODY: ${{ steps.get_pr_data.outputs.pr_body }}
          FILES_JSON: ${{ steps.get_pr_data.outputs.files_json }}
        with:
          script: |
            /**
             * Validations:
             *  - PR body must include the exact checklist item OR
             *    a marker file must be present among changed files
             *  - If code files were modified, ensure tests are added/modified
             */
            const body = (process.env.PR_BODY || '').trim();
            const files = JSON.parse(process.env.FILES_JSON || '[]');

            // required checklist (allow both raw text and checkbox variation)
            const requiredText = 'I read and followed doc/conventions.md';
            const checkboxRegex = /^\s*[-*]\s*\[\s*[xX]?\s*\]\s*I read and followed doc\/conventions\.md/m;

            const normalizedFilenames = files.map(f => (f.filename || '').toLowerCase());

            const hasRequiredText = body.includes(requiredText) || checkboxRegex.test(body);

            if (!hasRequiredText) {
              core.setFailed(
                `PR description must include the checklist line: '${requiredText}' (exact text) ` +
                `or the checkbox variant (e.g. '- [x] ${requiredText}').` 
              );
              return;
            }

            // Identify code vs test files
            const codeFileRe = /\.(py|ts|tsx|js|jsx)$/i;
            const testFileRe = /(^|\/)tests?(\/|$)|(^|\/)(__tests__)(\/|$)|\.test\.(js|ts|tsx|py)$|\.spec\.(js|ts|tsx)$/i;

            const changedCodeFiles = files.filter(f => codeFileRe.test(f.filename) && !testFileRe.test(f.filename));
            const changedTestFiles = files.filter(f => testFileRe.test(f.filename));

            core.info(`Changed code files: ${changedCodeFiles.length}`);
            core.info(`Changed test files: ${changedTestFiles.length}`);

            if (changedCodeFiles.length === 0) {
              core.info('No code files detected that would require unit tests; nothing more to do.');
              return;
            }

            // If code changed, require at least one test change
            if (changedTestFiles.length === 0) {
              core.setFailed('This PR modifies code files but does not add or modify unit tests. ' +
                'Please add fast unit tests (happy path + 1 edge case) under a `tests/` folder or using `*.test.*` / `*.spec.*` patterns.');
              return;
            }

            core.info('PR passes conventions check (checkbox/marker + tests present).');

      - name: Post or update PR comment with remediation steps (on failure)
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No PR available to comment on.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;

            const botMarker = '<!-- pr-conventions-check -->';
            const requiredText = 'I read and followed doc/conventions.md';

            const body = `${botMarker}
            Thanks â€” the repository's PR conventions check failed. Please follow these steps to fix the PR:

            1) Add the exact checklist line to the PR description:
              - ${requiredText}

              (You may also use a checkbox: "- [x] ${requiredText}")

            2) If you changed code files, add fast unit tests (happy path + 1 edge case).
              Put tests under a \`tests/\` folder or use naming like \`*.test.*\` or \`*.spec.*\`.

            3) Reference any architectural rationale in \`doc/vision.md\` and link relevant issues.

            Quick examples (copy-paste):

            Python (pytest):
            \`\`\`python
            def test_my_feature_happy_path():
                assert 1 + 1 == 2
            \`\`\`

            Jest + TypeScript:
            \`\`\`ts
            // tests/example.test.ts
            import { describe, test, expect } from '@jest/globals';

            describe('example suite', () => {
              test('happy path', () => {
                expect(1 + 2).toBe(3);
              });
            });
            \`\`\`

            Resources:
            - Conventions: \`doc/conventions.md\`
            - Vision/design rationale: \`doc/vision.md\`

            If you think this check is incorrect, reply here and request a maintainer review.
            `;

            // Find existing comment by bot marker
            const commentsRes = await github?.issues?.listComments?.({ owner, repo, issue_number, per_page: 100 });
            const comments = (commentsRes && commentsRes.data) || [];

            const existing = comments.find(c => c && c.body && c.body.startsWith(botMarker) &&
              (c.user && (c.user.type === 'Bot' || c.user.login === 'github-actions[bot]')));

            if (existing) {
              await github?.issues?.updateComment?.({ owner, repo, comment_id: existing.id, body });
              core.info('Updated existing bot comment.');
            } else {
              await github?.issues?.createComment?.({ owner, repo, issue_number, body });
              core.info('Created remediation comment on PR.');
              }

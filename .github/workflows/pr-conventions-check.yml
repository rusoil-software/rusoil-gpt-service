name: PR Conventions Check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  enforce-conventions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Debug: print PR body and changed files (non-failing)
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const pr = context.payload.pull_request || {};
              const body = pr.body || '';
              core.info('--- PR BODY START ---');
              core.info(body.substring(0, 8000));
              core.info('--- PR BODY END ---');

              const prNumber = pr.number;
              if (!prNumber) { core.info('No PR number available in context'); return; }

              let page = 1;
              const per_page = 100;
              let files = [];
              while (true) {
                const res = await github.pulls.listFiles({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, per_page, page });
                if (!res || !res.data) break;
                files = files.concat(res.data.map(f => f.filename));
                if (res.data.length < per_page) break;
                page += 1;
              }
              core.info(`Changed files (${files.length}):\n${files.join('\n')}`);
            } catch (e) {
              core.info('Debug step failed to list PR files: ' + String(e));
            }
      - name: Check PR body and changed files for conventions and tests
        uses: actions/github-script@v6
        with:
          script: |
            const core = require('@actions/core');
            const body = context.payload.pull_request && context.payload.pull_request.body || '';
            const requiredCheckbox = 'I read and followed doc/conventions.md';

            // Allow either the exact checklist line in the PR body OR a marker file added to the PR (useful for automation)
            // Marker files we accept: CONVENTIONS_ACKNOWLEDGED or doc/conventions_acknowledged.md
            const allowedMarkerFiles = ['CONVENTIONS_ACKNOWLEDGED', 'doc/conventions_acknowledged.md'];

            // Fetch changed files (we'll reuse the later logic to collect files)
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const per_page = 100;
            let page = 1;
            let files = [];
            while (true) {
              const res = await github.pulls.listFiles({ owner, repo, pull_number: prNumber, per_page, page });
              if (!res || !res.data) break;
              files = files.concat(res.data.map(f => ({ filename: f.filename, status: f.status })));
              if (res.data.length < per_page) break;
              page += 1;
            }

            const changedFilenames = files.map(f => f.filename.toLowerCase());

            // Accept marker files if any changed filename endsWith one of the allowed markers (case-insensitive)
            const hasMarkerFile = changedFilenames.some(fn => allowedMarkerFiles.some(m => fn.endsWith(m.toLowerCase())));

            if (!body.includes(requiredCheckbox) && !hasMarkerFile) {
              core.setFailed(`PR description must include the exact checklist item: '${requiredCheckbox}', or add one of ${JSON.stringify(allowedMarkerFiles)} to the PR (filename match is case-insensitive). Please update the PR description or add the marker file.`);
              return;
            }

            core.info(`Files changed in PR (${files.length}):\n${files.map(f => f.filename).join('\n')}`);

            // Identify code files (likely to require tests)
            const codeFileRe = /\.(py|ts|tsx|js|jsx)$/i;
            const testFileRe = /(^|\/)tests?(\/|$)|(^|\/)(__tests__)(\/|$)|\.test\.(js|ts|tsx|py)$|\.spec\.(js|ts|tsx)$/i;

            const changedCodeFiles = files.filter(f => codeFileRe.test(f.filename) && !testFileRe.test(f.filename));

            if (changedCodeFiles.length === 0) {
              core.info('No code files changed that require unit tests.');
              return;
            }

            // Check if any of the changed files include tests
            const changedTestFiles = files.filter(f => testFileRe.test(f.filename));

            if (changedTestFiles.length === 0) {
              core.setFailed('This PR modifies code files but does not add or modify unit tests. Please add fast unit tests (happy path + 1 edge case) under a tests/ folder or using *.test.* / *.spec.* patterns.');
            } else {
              core.info(`Found test files in PR:\n${changedTestFiles.map(f => f.filename).join('\n')}`);
            }

      - name: Post or update PR comment with remediation steps (on failure)
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            if (!pr) return;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;

            // Marker used to identify the bot's comment so it can be updated instead of duplicated
            const botMarker = '<!-- pr-conventions-check -->';

            const body = `${botMarker}\nThanks â€” the repository's PR conventions check failed. Please follow these steps to fix the PR:\n\n1) Add the exact checklist line to the PR description:\n   - I read and followed doc/conventions.md\n\n2) If you changed code files, add fast unit tests (happy path + 1 edge case). Put tests under a \`tests/\` folder or use naming like \`*.test.*\` or \`*.spec.*\`.\n\n3) Reference any architectural rationale in \`doc/vision.md\` and link to relevant issues.\n\nQuick examples (copy-paste):\n\nPython (pytest):\n```python\ndef test_my_feature_happy_path():\n    assert 1 + 1 == 2\n```\n\nJest + TypeScript:\n```ts\n// tests/example.test.ts\nimport { describe, test, expect } from '@jest/globals';\n\ndescribe('example suite', () => {\n  test('happy path', () => {\n    expect(1 + 2).toBe(3);\n  });\n});\n```\n\nResources:\n- Conventions: \`doc/conventions.md\`\n- Vision/design rationale: \`doc/vision.md\`\n\nIf you think this check is incorrect, reply here and request a maintainer review.\n`;

            // List existing comments on this PR and try to find our bot comment
            const commentsRes = await github.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const comments = commentsRes && commentsRes.data ? commentsRes.data : [];

            const existing = comments.find(c => c && c.body && c.body.startsWith(botMarker) && c.user && (c.user.type === 'Bot' || c.user.login === 'github-actions[bot]'));

            if (existing) {
              // update existing comment
              await github.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              // create new comment
              await github.issues.createComment({ owner, repo, issue_number, body });
            }
